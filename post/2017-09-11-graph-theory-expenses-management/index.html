<!DOCTYPE html>
<html lang="en-ca">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.4.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Mathieu Besançon">

  
  
  
    
  
  <meta name="description" content="Graph theory and Julia to solve the boring aspect of having friends
">

  
  <link rel="alternate" hreflang="en-ca" href="https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/">

  


  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.11bfb5db527d0300a83b31a367badc35.css">

  

  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@matbesancon">
  <meta property="twitter:creator" content="@matbesancon">
  
  <meta property="og:site_name" content="μβ">
  <meta property="og:url" content="https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/">
  <meta property="og:title" content="Solving the group expenses headache with graphs | μβ">
  <meta property="og:description" content="Graph theory and Julia to solve the boring aspect of having friends
"><meta property="og:image" content="https://matbesancon.github.io/img/posts/expense/graphviz.png">
  <meta property="twitter:image" content="https://matbesancon.github.io/img/posts/expense/graphviz.png"><meta property="og:locale" content="en-ca">
  
  <meta property="article:published_time" content="2018-01-15T00:00:00&#43;01:00">
  
  <meta property="article:modified_time" content="2019-05-06T16:12:13&#43;02:00">
  

  


  





  <title>Solving the group expenses headache with graphs | μβ</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">μβ</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#talks"><span>Talks</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article" itemscope itemtype="http://schema.org/Article">

  









<div class="article-header">
  
  
  <img src="/img/posts/expense/graphviz.png" class="article-banner" itemprop="image" alt="">
  

  
</div>




  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Solving the group expenses headache with graphs</h1>

  

  
    



<meta content="2018-01-15 00:00:00 &#43;0100 CET" itemprop="datePublished">
<meta content="2019-05-06 16:12:13 &#43;0200 CEST" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
          Last updated on
      
    
    <time>2019-05-06</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    8 min read
  </span>
  

  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/&amp;text=Solving%20the%20group%20expenses%20headache%20with%20graphs" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/&amp;t=Solving%20the%20group%20expenses%20headache%20with%20graphs" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Solving%20the%20group%20expenses%20headache%20with%20graphs&amp;body=https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/&amp;title=Solving%20the%20group%20expenses%20headache%20with%20graphs" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Solving%20the%20group%20expenses%20headache%20with%20graphs%20https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://matbesancon.github.io/post/2017-09-11-graph-theory-expenses-management/&amp;title=Solving%20the%20group%20expenses%20headache%20with%20graphs" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <p>With the end-of-year celebrations, we all had some expenses to manage,
some of them shared with friends, and we all have this eternal problem
of splitting them fairly.</p>
<blockquote>
<p><em>Les bons comptes font les bons amis.</em>
French wisdom</p>
</blockquote>
<p>Applications like <a href="https://tricount.com/">Tricount</a> or
<a href="https://www.splitwise.com/">Splitwise</a> became famous precisely by
solving this problem for you: just enter the expenses one by one, with who
owes whom and you&rsquo;ll get the simplest transactions to balance the amounts at
the end.</p>
<p>In this post, we&rsquo;ll model the expense balancing problem from a graph
perspective and see how to come up with a solution using Julia and the
JuliaGraphs ecosystem [1].</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="the-expenses-model">The expenses model</h2>
<p>Say that we have $n$ users involved in the expenses. An expense
$\delta$ is defined by an amount spent $\sigma$, the user who paid the
expense $p$ and a non-empty set of users who are accountable for
this expense $a$.</p>
<blockquote>
<p>$\delta = (\sigma, p, a)$</p>
</blockquote>
<p>The total of all expenses $\Sigma$ can be though of as: for any two users $u_i$ and $u_j$,
the total amount that $u_i$ spent for $u_j$. So the expenses are a vector of
triplets <em>(paid by, paid for, amount)</em>.</p>
<p>As an example, if I went out for
pizza with Joe and paid 8GPHC for the two of us, the expense is modeled as:</p>
<blockquote>
<p>$\delta = (\sigma: 8GPHC, p: Mathieu, a: [Mathieu, Joe])$.</p>
</blockquote>
<p>Now considering I don&rsquo;t keep track of money I owe myself, the sum of all expenses
is the vector composed of one triplet:</p>
<blockquote>
<p>$\Sigma = [(Mathieu, Joe, \frac{8}{2} = 4)]$</p>
</blockquote>
<p>In Julia, the expense information can be translated to a structure:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">const</span> User <span style="color:#f92672">=</span> <span style="color:#66d9ef">Int</span>
<span style="color:#66d9ef">const</span> GraphCoin <span style="color:#f92672">=</span> <span style="color:#66d9ef">Float16</span>
<span style="color:#66d9ef">struct</span> Expense
    payer<span style="color:#f92672">::</span>User
    amount<span style="color:#f92672">::</span>GraphCoin
    users<span style="color:#f92672">::</span><span style="color:#66d9ef">Set</span>{User}
<span style="color:#66d9ef">end</span></code></pre></div></p>
<h2 id="reducing-expenses">Reducing expenses</h2>
<p>Now that we have a full representation of the expenses,
the purpose of balancing is to find a vector of transactions which cancels out
the expenses. A naive approach would be to use the transposed expense matrix
as a transaction matrix. If $u_i$ paid $\Sigma_{i,j}$ for $u_j$,
then $u_j$ paying back that exact amount to $u_i$ will solve the problem.
So we need in the worst case as many transactions after the trip as
$|u| \cdot (|u| - 1)$. For 5 users, that&rsquo;s already 20 transactions,
how can we improve it?</p>
<h2 id="breaking-strongly-connected-components">Breaking strongly connected components</h2>
<p>Suppose that I paid the pizza slice to Joe for 4GPHC, but he bought me an ice
cream for 2GPHC the day after. In the naive models, we would have two
transactions after the trip: he give me 4GPHC and I would give him 2GPHC. That
does not make any sense, he should simply pay the difference between what he
owes me and what I owe him. For any pair of users, there should only be
at most one transaction from the most in debt to the other, this result in the
worst case of $\frac{|u| \cdot (|u| - 1)}{2}$ transactions, so 10 transactions
for 5 people.</p>
<p>Now imagine I still paid 4GPHC for Joe, who paid 2GPHC for Marie, who paid 4GPHC
for me. In graph terminology, this is called a
<em><a href="https://en.wikipedia.org/wiki/Strongly_connected_component">strongly connected component</a></em>.
The point here is that transactions will flow from one user to the next one,
and back to the first.</p>
<p>If there is a cycle, we can find the minimal due sum within it. In our 3-people
case, it is 2GPHC. That&rsquo;s the amount which is just moving from hand to hand and
back at the origin: it can be forgotten. This yields a new net debt:
I paid 2GPHC for Joe, Marie paid 2GPHC for me. We reduced the number of
transactions and the amount due thanks to this cycle reduction.</p>
<h2 id="expenses-as-a-flow-problem">Expenses as a flow problem</h2>
<p>To simplify the problem, we can notice we don&rsquo;t actually care about who paid
whom for what, a fair reimbursement plan only requires two conditions:</p>
<ol>
<li>All people who are owed some money are given at least that amount</li>
<li>People who owe money don&rsquo;t pay more than the net amount they ought to pay</li>
</ol>
<p>We can define a directed flow network with users split in two sets of vertices,
depending on whether they owe or are owed money. We call these two sets $V_1$
and $V_2$ respectively.</p>
<ul>
<li>There is an edge from any node of $V_1$ to any node of $V_2$.</li>
<li>We define a <em>source</em> noted $s$ connected to all vertices in $V_1$, the edge
from $s$ to any node of $V_1$ has a capacity equal to what they owe.</li>
<li>We define a <em>sink</em> noted $t$ to which all vertices in $V_2$ connect, with
infinite capacity and a demand (the minimal flow that has to pass through) equal
to what they are owed.</li>
</ul>
<p>With this model, GraphCoins will flow from user owing money to users who are
owed money, see <a href="https://en.wikipedia.org/wiki/Maximum_flow_problem">Wikipedia description of the flow problem</a>.</p>
<h3 id="computing-net-owed-amount-per-user">Computing net owed amount per user</h3>
<p>Given a vector of expenses, we should be able to build the matrix holding what
is owed in net from a user to another:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Builds the matrix of net owed GraphCoins
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">function</span> compute_net_owing(expenses<span style="color:#f92672">::</span><span style="color:#66d9ef">Vector</span>{Expense}, nusers<span style="color:#f92672">::</span><span style="color:#66d9ef">Int</span>)
    owing_matrix <span style="color:#f92672">=</span> zeros(GraphCoin, nusers, nusers)
    <span style="color:#75715e"># row owes to column</span>
    <span style="color:#66d9ef">for</span> expense <span style="color:#66d9ef">in</span> expenses
        <span style="color:#66d9ef">for</span> user <span style="color:#66d9ef">in</span> expense<span style="color:#f92672">.</span>users
            <span style="color:#66d9ef">if</span> user <span style="color:#f92672">!=</span> expense<span style="color:#f92672">.</span>payer
                owing_matrix[user,expense<span style="color:#f92672">.</span>payer] <span style="color:#f92672">+=</span> expense<span style="color:#f92672">.</span>amount <span style="color:#f92672">/</span> length(expense<span style="color:#f92672">.</span>users)
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
    <span style="color:#75715e"># compute net owed amount</span>
    net_owing <span style="color:#f92672">=</span> zeros(GraphCoin, nusers, nusers)    
    <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>nusers<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">for</span> j <span style="color:#66d9ef">in</span> i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>nusers
            <span style="color:#66d9ef">if</span> owing_matrix[i,j] <span style="color:#f92672">&gt;</span> owing_matrix[j,i]
                net_owing[i,j] <span style="color:#f92672">=</span> owing_matrix[i,j] <span style="color:#f92672">-</span> owing_matrix[j,i]
            <span style="color:#66d9ef">elseif</span> owing_matrix[i,j] <span style="color:#f92672">&lt;</span> owing_matrix[j,i]
                net_owing[j,i] <span style="color:#f92672">=</span> owing_matrix[j,i] <span style="color:#f92672">-</span> owing_matrix[i,j]
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">return</span> net_owing
<span style="color:#66d9ef">end</span></code></pre></div>
<p>From that matrix, we should determine the net amount any user owes or is owed:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    What is owed to a given user (negative if user owes money)
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">function</span> net_owed_user(net_owing<span style="color:#f92672">::</span><span style="color:#66d9ef">Matrix</span>{GraphCoin})
    <span style="color:#66d9ef">return</span> (sum(net_owing,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">&#39;</span> <span style="color:#f92672">-</span> sum(net_owing,<span style="color:#ae81ff">2</span>))[<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]
<span style="color:#66d9ef">end</span></code></pre></div></p>
<p>The <code>sum</code> function used with <code>1</code> or <code>2</code> sums a matrix over its rows, columns
respectively. This computes a difference between what a user is owed and what
they owe.</p>
<h3 id="building-the-graph-and-the-corresponding-flow-problem">Building the graph and the corresponding flow problem</h3>
<p>A flow problem is determined by the directed graph (nodes and directed edges),
the minimal flow for any edge, a maximal flow or capacity for any edge and a
cost of having a certain flow going through each edge.</p>
<p>First, we need to import LightGraphs, the core package of the JuliaGraph
ecosystem containing essential types.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">import</span> LightGraphs; <span style="color:#66d9ef">const</span> lg <span style="color:#f92672">=</span> LightGraphs
</code></pre></div><blockquote>
<p>Note that I use explicit package import (not <code>using</code>), an habit I
kept from using Python and that I consider more readable than importing
the whole package into the namespace. <code>lg</code> has become my usual name for the
LightGraphs package.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> build_graph(net_owing<span style="color:#f92672">::</span><span style="color:#66d9ef">Matrix</span>{GraphCoin})
    nusers <span style="color:#f92672">=</span> size(net_owing,<span style="color:#ae81ff">1</span>)
    g <span style="color:#f92672">=</span> lg<span style="color:#f92672">.</span>DiGraph(nusers <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>)
    source <span style="color:#f92672">=</span> nusers <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
    sink <span style="color:#f92672">=</span> nusers <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>
    net_user <span style="color:#f92672">=</span> net_owed_user(net_owing)
    v1 <span style="color:#f92672">=</span> [idx <span style="color:#66d9ef">for</span> idx <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>nusers <span style="color:#66d9ef">if</span> net_user[idx] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>]
    v2 <span style="color:#f92672">=</span> [idx <span style="color:#66d9ef">for</span> idx <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>nusers <span style="color:#66d9ef">if</span> net_user[idx] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>]
    capacity <span style="color:#f92672">=</span> zeros(GraphCoin, nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
    demand <span style="color:#f92672">=</span> zeros(GraphCoin, nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
    maxcap <span style="color:#f92672">=</span> sum(net_owing)
    <span style="color:#66d9ef">for</span> u1 <span style="color:#66d9ef">in</span> v1
        lg<span style="color:#f92672">.</span>add_edge!(g,source,u1)
        capacity[source,u1] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>net_user[u1]
        <span style="color:#66d9ef">for</span> u2 <span style="color:#66d9ef">in</span> v2
            lg<span style="color:#f92672">.</span>add_edge!(g,u1,u2)
            capacity[u1,u2] <span style="color:#f92672">=</span> maxcap
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">for</span> u2 <span style="color:#66d9ef">in</span> v2
        lg<span style="color:#f92672">.</span>add_edge!(g,u2,sink)
        capacity[u2,sink] <span style="color:#f92672">=</span> maxcap
        demand[u2,sink] <span style="color:#f92672">=</span> net_user[u2]
    <span style="color:#66d9ef">end</span>
    (g, capacity, demand)
<span style="color:#66d9ef">end</span></code></pre></div>
<p>This function builds our graph structure and all data we need attached.</p>
<h3 id="solving-the-flow-problem">Solving the flow problem</h3>
<p>Now that the components are set, we can solve the problem using another
component of the JuliaGraphs ecosystem specialized for flow problems:</p>
<pre><code>using LightGraphsFlows: mincost_flow
using Clp: ClpSolver
</code></pre><p>We also need a Linear Programming solver to pass to the flow solver, all we
have to do is bundle the pieces together:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> solve_expense(expenses<span style="color:#f92672">::</span><span style="color:#66d9ef">Vector</span>{Expense}, nusers<span style="color:#f92672">::</span><span style="color:#66d9ef">Int</span>)
    (g, capacity, demand) <span style="color:#f92672">=</span> build_graph(compute_net_owing(expenses, nusers))
    flow <span style="color:#f92672">=</span> mincost_flow(g, capacity, demand, ones(nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>,nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>), ClpSolver(), nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, nusers<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
    <span style="color:#66d9ef">return</span> flow[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#66d9ef">end</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#66d9ef">end</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
<span style="color:#66d9ef">end</span></code></pre></div>
<p>We truncate the <code>flow</code> matrix because we are only interested in what users
are paying each other, not in the flows from and to the source and sink.</p>
<h3 id="trying-out-our-solution">Trying out our solution</h3>
<p>Now that all functions are set, we can use it on any expense problem:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">expenses <span style="color:#f92672">=</span> [
    Expense(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">Set</span>([<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>])),
    Expense(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">24</span>, <span style="color:#66d9ef">Set</span>([<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>])),
    Expense(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">Set</span>([<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>]))
]
solve_expense(expenses, <span style="color:#ae81ff">3</span>)</code></pre></div>
<pre><code>3×3 Array{Float64,2}:
  0.0  0.0  0.0
 18.0  0.0  0.0
  3.0  0.0  0.0
</code></pre><p>In the result, each row pays to each column and voilà! Our three users don&rsquo;t
have to feel the tension of unpaid debts anymore.</p>
<h2 id="conclusion-perspective-and-note-on-gphc">Conclusion, perspective and note on GPHC</h2>
<p>We managed to model our specific problem using <em>LightGraphs.jl</em> and the
associated flow package pretty easily. I have to admit being biased since
I contributed to the JuliaGraphs ecosystem, if your impression is different
or if you have some feedback, don&rsquo;t hesitate to file an issue on the
<a href="https://github.com/JuliaGraphs">corresponding package</a>, some awesome people
will help you figure things out as they helped me.</p>
<p>There is one thing we ignored in our model, it&rsquo;s the number of transactions
realized. Using this as an objective turns the problem into a
<a href="https://en.wikipedia.org/wiki/Integer_programming#Variants">Mixed-Integer Linear Programming</a> one,
which are much harder to solve and cannot use simple flow techniques. However,
I still haven&rsquo;t found a case where our simple approach does not yield the
smallest number of transactions.</p>
<p>Final word: I started the idea of this article long before the crypto-madness
(September actually), when currencies where still considered as boring,
nerdy or both, sorry about following the (late) hype. I even changed
GraphCoin symbol to GPHC because I found another one with which my initial
name conflicted.</p>
<p>If you have questions or remarks on LightGraphs, LightGraphsFlows, the article
or anything related, don&rsquo;t hesitate to <a href="http://twitter.com/matbesancon">ping me</a>!</p>
<p>Edits:<br>
Special thanks to <a href="http://www.bromberger.com/">Seth Bromberger</a> for the review.</p>
<hr>
<p>The cover image was created using
<a href="https://github.com/JuliaGraphs/GraphPlot.jl">GraphPlot.jl</a>.</p>
<p>[1] James Fairbanks Seth Bromberger and other contributors. Juliagraphs/LightGraphs.jl:
Lightgraphs, 2017, <a href="https://doi.org/10.5281/zenodo.889971">https://doi.org/10.5281/zenodo.889971</a>. DOI: 10.5281/zenodo.889971</p>

    </div>

    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/graph/">graph</a>
  
  <a class="badge badge-light" href="/tags/julia/">julia</a>
  
</div>



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hu717a6920346f3d435e65e27c2a66c1ed_48773_250x250_fill_q90_lanczos_center.jpg" itemprop="image" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://matbesancon.github.io/">Mathieu Besançon</a></h5>
      <h6 class="card-subtitle">Postdoctoral researcher, mathematical optimization</h6>
      <p class="card-text" itemprop="description">Mathematical optimization, scientific programming and related.</p>
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="/#contact" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/matbesancon" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://scholar.google.com/citations?user=-xStCAIAAAAJ" target="_blank" rel="noopener">
              <i class="ai ai-google-scholar"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://github.com/matbesancon" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://orcid.org/0000-0002-6284-3033" target="_blank" rel="noopener">
              <i class="ai ai-orcid"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://www.youtube.com/channel/UCVSd42nW_MqkbSXijgOvKwg" target="_blank" rel="noopener">
              <i class="fab fa-youtube"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://linkedin.com/in/mbesancon" target="_blank" rel="noopener">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/project/juliagraphs/">JuliaGraphs contributions</a></li>
          
          <li><a href="/post/2017-12-20-diffeq-julia2/">DifferentialEquations.jl - part 2: decision from the model</a></li>
          
          <li><a href="/post/2017-12-14-diffeq-julia/">Getting started with DifferentialEquations.jl</a></li>
          
        </ul>
      </div>
      
    

    

    


  </div>
</article>

      

    
    
    
    <script src="/js/mathjax-config.js"></script>
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.0.0/mermaid.min.js" integrity="sha256-0w92bcB21IY5+rGI84MGj52jNfHNbXVeQLrZ0CGdjNY=" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/julia.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/scala.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/rust.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/go.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/shell.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/dockerfile.min.js"></script>
        
      

      
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML-full" integrity="sha256-GhM+5JHb6QUzOQPXSJLEWP7R73CbkisjzK5Eyij4U9w=" crossorigin="anonymous" async></script>
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.16bbb3750feb7244c9bc409a5a4fe678.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    © 2021 Mathieu Besançon &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
