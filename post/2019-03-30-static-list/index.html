<!DOCTYPE html>
<html lang="en-ca">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.4.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Mathieu Besançon">

  
  
  
    
  
  <meta name="description" content="Pushing the type system for more compile-time information
">

  
  <link rel="alternate" hreflang="en-ca" href="https://matbesancon.github.io/post/2019-03-30-static-list/">

  


  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.11bfb5db527d0300a83b31a367badc35.css">

  

  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://matbesancon.github.io/post/2019-03-30-static-list/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@matbesancon">
  <meta property="twitter:creator" content="@matbesancon">
  
  <meta property="og:site_name" content="μβ">
  <meta property="og:url" content="https://matbesancon.github.io/post/2019-03-30-static-list/">
  <meta property="og:title" content="Static lists in Julia | μβ">
  <meta property="og:description" content="Pushing the type system for more compile-time information
"><meta property="og:image" content="https://matbesancon.github.io/img/posts/staticlist/chain.jpg">
  <meta property="twitter:image" content="https://matbesancon.github.io/img/posts/staticlist/chain.jpg"><meta property="og:locale" content="en-ca">
  
  <meta property="article:published_time" content="2019-03-30T00:00:00&#43;01:00">
  
  <meta property="article:modified_time" content="2019-04-07T22:56:16&#43;02:00">
  

  


  





  <title>Static lists in Julia | μβ</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">μβ</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#talks"><span>Talks</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article" itemscope itemtype="http://schema.org/Article">

  









<div class="article-header">
  
  
  <img src="/img/posts/staticlist/chain.jpg" class="article-banner" itemprop="image" alt="">
  

  
</div>




  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Static lists in Julia</h1>

  

  
    



<meta content="2019-03-30 00:00:00 &#43;0100 CET" itemprop="datePublished">
<meta content="2019-04-07 22:56:16 &#43;0200 CEST" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
          Last updated on
      
    
    <time>2019-04-07</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    8 min read
  </span>
  

  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://matbesancon.github.io/post/2019-03-30-static-list/&amp;text=Static%20lists%20in%20Julia" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://matbesancon.github.io/post/2019-03-30-static-list/&amp;t=Static%20lists%20in%20Julia" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Static%20lists%20in%20Julia&amp;body=https://matbesancon.github.io/post/2019-03-30-static-list/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://matbesancon.github.io/post/2019-03-30-static-list/&amp;title=Static%20lists%20in%20Julia" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Static%20lists%20in%20Julia%20https://matbesancon.github.io/post/2019-03-30-static-list/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://matbesancon.github.io/post/2019-03-30-static-list/&amp;title=Static%20lists%20in%20Julia" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <hr>
<p>This post explores the possibility to build static lists in Julia, meaning
lists for which the size is known at compile-time. This is inspired by
a <a href="https://aerodatablog.wordpress.com/2019/03/03/a-typedlist-in-scala/#joe_barnes_talk">post</a>
on a Scala equivalent but will take different roads to see more than a plain port.
Of course, this implementation is not that handy nor efficient but
is mostly meant to push the limits of the type system,
especially a trick of using recursive types as values
(replacing a dependent type system).
Some other references:</p>
<ul>
<li>The list operations are inspired by the implementation in <a href="https://github.com/JuliaCollections/DataStructures.jl"><em>DataStructures.jl</em></a></li>
<li><a href="https://github.com/JuliaArrays/StaticArrays.jl"><em>StaticArrays.jl</em></a> is a good inspiration for static data structures in Julia</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="first-thoughts-value-type-parameter">First thoughts: value type parameter</h1>
<p>Julia allows developers to define type parameters.
In the case of a list, the most obvious one may be the
type of data it contains:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">abstract type</span> MyList{T} <span style="color:#66d9ef">end</span></code></pre></div></p>
<p>Some types are however parametrized on other things, if we look at the
definition of <code>AbstractArray</code> for example:</p>
<blockquote>
<pre><code>  AbstractArray{T,N}
</code></pre>
<p>Supertype for N-dimensional arrays (or array-like types) with elements of type T.</p>
</blockquote>
<p>The two type parameters are another type <code>T</code> and integer <code>N</code> for the
dimensionality (tensor rank). The only constraint for a value to be
an acceptable type parameter is to be composed of plain bits, complying
with <code>isbitstype</code>.</p>
<p>This looks great, we could define our StaticList
directly using integers.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">A static list of type `T` and length `L`
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">abstract type</span> StaticList{T,L} <span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> Nil{T} <span style="color:#f92672">&lt;:</span> StaticList{T,<span style="color:#ae81ff">0</span>} <span style="color:#66d9ef">end</span>

StaticList{T}() where T <span style="color:#f92672">=</span> Nil{T}()
StaticList(v<span style="color:#f92672">::</span>T) where T <span style="color:#f92672">=</span> Cons(v, Nil{T}())

<span style="color:#66d9ef">struct</span> Cons{T,L} <span style="color:#f92672">&lt;:</span> StaticList{T,L<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>}
    h<span style="color:#f92672">::</span>T
    t<span style="color:#f92672">::</span>StaticList{T,L}
    <span style="color:#66d9ef">function</span> Cons(v<span style="color:#f92672">::</span>T, t<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L}
        new{T,L}(v,t)
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#75715e"># Usage:</span>
<span style="color:#75715e"># Cons(3, Nil{Int}()) is of type StaticList{Int,1}</span>
<span style="color:#75715e"># Cons(4, Cons(3, Nil{Int}())) is of type StaticList{Int,2}</span></code></pre></div>
<p>If you try to evaluate this code, you will get an error:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">ERROR<span style="color:#f92672">:</span> <span style="color:#66d9ef">MethodError</span><span style="color:#f92672">:</span> no method matching <span style="color:#f92672">+</span>(<span style="color:#f92672">::</span><span style="color:#66d9ef">TypeVar</span>, <span style="color:#f92672">::</span><span style="color:#66d9ef">Int64</span>)</code></pre></div></p>
<p>Pretty explicit, you cannot perform any computation on values used as type
parameters. With more complex operations, this could make the compiler hang,
crash or at least perform poorly (we would be forcing the compiler to execute
this code at compile-time).</p>
<p>One way there might be around this is macros or replacing sub-typing with
another mechanism. For the macro-based approach,
<a href="https://github.com/vtjnash/ComputedFieldTypes.jl">ComputedFieldTypes.jl</a>
does exactly that. More discussion on computed type parameters in
[1] and [2].</p>
<p><strong>Edit</strong>: using integer type parameters can be achieved using <em>ComputedFieldTypes.jl</em> as such:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">using</span> ComputedFieldTypes

julia<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">abstract type</span> StaticList{T,L} <span style="color:#66d9ef">end</span>

julia<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">struct</span> Nil{T} <span style="color:#f92672">&lt;:</span> StaticList{T,<span style="color:#ae81ff">0</span>} <span style="color:#66d9ef">end</span>

julia<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">@computed</span> <span style="color:#66d9ef">struct</span> Cons{T,L} <span style="color:#f92672">&lt;:</span> StaticList{T,L}
           h<span style="color:#f92672">::</span>T
           t<span style="color:#f92672">::</span>StaticList{T,L<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>}
           <span style="color:#66d9ef">function</span> Cons(v<span style="color:#f92672">::</span>T, t<span style="color:#f92672">::</span>StaticList{T,L0}) where {T,L0}
               L <span style="color:#f92672">=</span> L0<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
               new{T,L}(v,t)
           <span style="color:#66d9ef">end</span>
       <span style="color:#66d9ef">end</span>

julia<span style="color:#f92672">&gt;</span> Cons(<span style="color:#ae81ff">3</span>, Nil{<span style="color:#66d9ef">Int</span>}())
Cons{<span style="color:#66d9ef">Int64</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>}(<span style="color:#ae81ff">3</span>, Nil{<span style="color:#66d9ef">Int64</span>}())

julia<span style="color:#f92672">&gt;</span> Cons(<span style="color:#ae81ff">4</span>, Cons(<span style="color:#ae81ff">3</span>, Nil{<span style="color:#66d9ef">Int</span>}()))
Cons{<span style="color:#66d9ef">Int64</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>}(<span style="color:#ae81ff">4</span>, Cons{<span style="color:#66d9ef">Int64</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>}(<span style="color:#ae81ff">3</span>, Nil{<span style="color:#66d9ef">Int64</span>}()))</code></pre></div>
<p>This might be the neatest option for building the <code>StaticList</code>.</p>
<h1 id="recursive-natural-numbers">Recursive natural numbers</h1>
<p>We can use the same technique as in the Scala post, representing natural
number using recursive types.</p>
<ul>
<li><code>ZeroLength</code> is a special singleton type</li>
<li><code>Next{L}</code> represents the number following the one represented by <code>L</code></li>
</ul>
<p>We can modify our previous example:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">A type parameter for List length, the numerical length can be retrieved
</span><span style="color:#e6db74">using `length(l::Length)`
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">abstract type</span> Length <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">struct</span> ZeroLength <span style="color:#f92672">&lt;:</span> Length <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">struct</span> Next{L<span style="color:#f92672">&lt;:</span>Length} <span style="color:#f92672">&lt;:</span> Length <span style="color:#66d9ef">end</span>

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">A linked list of size known at compile-time
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">abstract type</span> StaticList{T,L<span style="color:#f92672">&lt;:</span>Length} <span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> Nil{T} <span style="color:#f92672">&lt;:</span> StaticList{T,ZeroLength} <span style="color:#66d9ef">end</span>

StaticList{T}() where T <span style="color:#f92672">=</span> Nil{T}()
StaticList(v<span style="color:#f92672">::</span>T) where T <span style="color:#f92672">=</span> Cons(v, Nil{T}())

<span style="color:#66d9ef">struct</span> Cons{T,L<span style="color:#f92672">&lt;:</span>Length} <span style="color:#f92672">&lt;:</span> StaticList{T,Next{L}}
    h<span style="color:#f92672">::</span>T
    t<span style="color:#f92672">::</span>StaticList{T,L}
    <span style="color:#66d9ef">function</span> Cons(v<span style="color:#f92672">::</span>T, t<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L<span style="color:#f92672">&lt;:</span>Length}
        new{T,L}(v,t)
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">By default, the type of the Nil is ignored if different
</span><span style="color:#e6db74">from the type of first value
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
Cons(v<span style="color:#f92672">::</span>T,<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{Nil{T1}}) where {T,T1} <span style="color:#f92672">=</span> Cons(v, Nil{T}())</code></pre></div></p>
<p>We can then define basic information for a list, its length:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">Base<span style="color:#f92672">.</span>length(<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{ZeroLength}) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
Base<span style="color:#f92672">.</span>length(<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{Next{L}}) where {L} <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> length(L)

Base<span style="color:#f92672">.</span>eltype(<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L} <span style="color:#f92672">=</span> T
Base<span style="color:#f92672">.</span>length(l<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L} <span style="color:#f92672">=</span> length(L)</code></pre></div>
<p>One thing should catch your attention in this block,
we use a recursive definition of <code>length</code> for the <code>Length</code> type,
which means we can blow our compiler. However, both of the definitions
are static, in the sense that they don&rsquo;t use type information, so
the final call should reduce to spitting out the length cached at compile-time.
You can confirm this is the case by checking the produced assembly instructions with <code>@code_native</code>.
We respected our contract of a list with size known at compile-time.</p>
<h1 id="implementing-a-list-y-behaviour">Implementing a list-y behaviour</h1>
<p>This part is heavily inspired by the <em>DataStructures.jl</em> list implementation,
as such we will not re-define methods with semantically similar but
implement them for our list type. Doing so for your own package
allows user to switch implementation for the same generic code.</p>
<p>The first operation is being able to join a head with an existing list:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">DataStructures<span style="color:#f92672">.</span>cons(v<span style="color:#f92672">::</span>T,l<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L} <span style="color:#f92672">=</span> Cons(v,l)

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Allows for `cons(v,Nil)`. Note that the `Nil` type is ignored.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
DataStructures<span style="color:#f92672">.</span>cons(v<span style="color:#f92672">::</span>T,<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{Nil}) where {T} <span style="color:#f92672">=</span> StaticList(v)

(<span style="color:#f92672">::</span><span style="color:#66d9ef">Colon</span>)(v<span style="color:#f92672">::</span>T,l<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L} <span style="color:#f92672">=</span> DataStructures<span style="color:#f92672">.</span>cons(v, l)
(<span style="color:#f92672">::</span><span style="color:#66d9ef">Colon</span>)(v<span style="color:#f92672">::</span>T,<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{Nil}) where {T,L} <span style="color:#f92672">=</span> DataStructures<span style="color:#f92672">.</span>cons(v, Nil{T})</code></pre></div>
<p>Implementing the odd <code>::Colon</code> methods allows for a very neat syntax:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">l0 <span style="color:#f92672">=</span> StaticList{<span style="color:#66d9ef">Int</span>}()
l1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>l0
l2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>l1</code></pre></div>
<p>Unlike the Scala post, we are not using the <code>::</code> operator which
is reserved for typing expressions in Julia.
We can add a basic head and tail methods, which allow querying
list elements without touching the inner structure. This
will be useful later on.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">DataStructures<span style="color:#f92672">.</span>head(l<span style="color:#f92672">::</span>Cons{T,L}) where {T,L} <span style="color:#f92672">=</span> l<span style="color:#f92672">.</span>h
DataStructures<span style="color:#f92672">.</span>tail(l<span style="color:#f92672">::</span>Cons{T,L}) where {T,L} <span style="color:#f92672">=</span> l<span style="color:#f92672">.</span>t</code></pre></div>
<p>Testing list equality can be done recursively, dispatching on the three
possible cases:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#f92672">==</span>(l1<span style="color:#f92672">::</span>StaticList, l2<span style="color:#f92672">::</span>StaticList) <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>

<span style="color:#66d9ef">function</span> <span style="color:#f92672">==</span>(l1<span style="color:#f92672">::</span>L1,l2<span style="color:#f92672">::</span>L2) where {T1,L,T2,L1<span style="color:#f92672">&lt;:</span>Cons{T1,L},L2<span style="color:#f92672">&lt;:</span>Cons{T2,L}}
    l1<span style="color:#f92672">.</span>h <span style="color:#f92672">==</span> l2<span style="color:#f92672">.</span>h <span style="color:#f92672">&amp;&amp;</span> l1<span style="color:#f92672">.</span>t <span style="color:#f92672">==</span> l2<span style="color:#f92672">.</span>t
<span style="color:#66d9ef">end</span>

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Two `Nil` are always considered equal, no matter the type
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#f92672">==</span>(<span style="color:#f92672">::</span>Nil,<span style="color:#f92672">::</span>Nil) <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span></code></pre></div>
<p>We can now define basic higher-order functions, such as <code>zip</code> below,
and implement the iteration interface.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>zip(l1<span style="color:#f92672">::</span>Nil{T1},l2<span style="color:#f92672">::</span>StaticList{T2,L2}) where {T1,T2,L2}
    Nil{<span style="color:#66d9ef">Tuple</span>{T1,T2}}
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>zip(l1<span style="color:#f92672">::</span>Cons{T1,L1},l2<span style="color:#f92672">::</span>Cons{T2,L2}) where {T1,L1,T2,L2}
    v <span style="color:#f92672">=</span> (l1<span style="color:#f92672">.</span>h, l2<span style="color:#f92672">.</span>h)
    Cons(v,zip(l1<span style="color:#f92672">.</span>t,l2<span style="color:#f92672">.</span>t))
<span style="color:#66d9ef">end</span>

Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>StaticList, <span style="color:#f92672">::</span>Nil) <span style="color:#f92672">=</span> nothing
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>StaticList, state<span style="color:#f92672">::</span>Cons <span style="color:#f92672">=</span> l)
    (state<span style="color:#f92672">.</span>h, state<span style="color:#f92672">.</span>t)
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Iterating over our lists is fairly straight-forward, and will be more efficient than
the recursive implementations of the higher-order functions, we still kept it for
equality checking, more a matter of keeping a functional style in line with the Scala post.</p>
<p>The case of list reversal is fairly straightforward: iterate and accumulate
the list in a new one.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>reverse(l<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L}
    l2 <span style="color:#f92672">=</span> Nil{T}
    <span style="color:#66d9ef">for</span> h <span style="color:#66d9ef">in</span> l
        l2 <span style="color:#f92672">=</span> Cons(h, l2)
    <span style="color:#66d9ef">end</span>
    l2
<span style="color:#66d9ef">end</span></code></pre></div>
<p>We define the cat operation between multiple lists.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>cat(l1<span style="color:#f92672">::</span>StaticList{T,L},l2<span style="color:#f92672">::</span>StaticList{T,L}) where {T,L}
    l <span style="color:#f92672">=</span> l2
    <span style="color:#66d9ef">for</span> e <span style="color:#66d9ef">in</span> reverse(l1)
        l <span style="color:#f92672">=</span> Cons(e, l)
    <span style="color:#66d9ef">end</span>
    l
<span style="color:#66d9ef">end</span></code></pre></div>
<p>The reverse is necessary to keep the order of the two lists.</p>
<h1 id="special-valued-lists">Special-valued lists</h1>
<p>Now that we have a basic static list implementation, we can spice things up.
<code>StaticList</code> is just an abstract type in our case, not an algebraic data type
as in common functional implementations, meaning we can define other sub-types.</p>
<p>Imagine a numeric list, with a series of zeros or ones somewhere.
Instead of storing all of them, we can find a smart way of representing them.
Let us define a static list of ones:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">struct</span> OnesStaticList{T<span style="color:#f92672">&lt;:</span><span style="color:#66d9ef">Number</span>,L<span style="color:#f92672">&lt;:</span>Length} <span style="color:#66d9ef">end</span>

Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>OnesStaticList, <span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{ZeroLength}) <span style="color:#f92672">=</span> nothing
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>OnesStaticList{T,L}, state<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{Next{L1}} <span style="color:#f92672">=</span> L) where <span style="color:#f92672">$</span>
    (one(T), L1)
<span style="color:#66d9ef">end</span></code></pre></div>
<p>This list corresponds to the 1 value of type <code>T</code>, repeated for all elements.
In a similar fashion, one can define a ZeroList:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">struct</span> ZerosStaticList{T<span style="color:#f92672">&lt;:</span><span style="color:#66d9ef">Number</span>,L<span style="color:#f92672">&lt;:</span>Length} <span style="color:#66d9ef">end</span>

Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>ZerosStaticList, <span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{ZeroLength}) <span style="color:#f92672">=</span> nothing
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>ZerosStaticList{T,L}, state<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{Next{L1}} <span style="color:#f92672">=</span> L) where<span style="color:#f92672">$</span>
    (zero(T), L1)
<span style="color:#66d9ef">end</span></code></pre></div>
<p>One thing to note is that these lists are terminal, in the sense that they cannot
be part of a greater list. To fix this, we can add a tail to these as follows:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">struct</span> ZerosStaticList{T<span style="color:#f92672">&lt;:</span><span style="color:#66d9ef">Number</span>,L<span style="color:#f92672">&lt;:</span>Length,TL<span style="color:#f92672">&lt;:</span>StaticList{T,<span style="color:#f92672">&lt;:</span>Length}}
	t<span style="color:#f92672">::</span>TL
<span style="color:#66d9ef">end</span>

Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>ZerosStaticList, <span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{ZeroLength}) <span style="color:#f92672">=</span> l<span style="color:#f92672">.</span>t
<span style="color:#66d9ef">function</span> Base<span style="color:#f92672">.</span>iterate(l<span style="color:#f92672">::</span>ZerosStaticList{T,L}, state<span style="color:#f92672">::</span><span style="color:#66d9ef">Type</span>{Next{L1}} <span style="color:#f92672">=</span> L) where<span style="color:#f92672">$</span>
    (zero(T), L1)
<span style="color:#66d9ef">end</span></code></pre></div></p>
<p>The <code>t</code> field of the list contains the tail after the series of zeros,
we can thus build a much simpler representation in case of long constant series.
In a similar fashion, one could define a constant list of <code>N</code> elements, storing
the value just once.</p>
<h1 id="multi-typed-lists">Multi-typed lists</h1>
<p>There is one last extension we can think of with this data structure.
Since we have a recursive length parameter, why not add it a type at each new node?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia"><span style="color:#66d9ef">abstract type</span> TLength <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">struct</span> TZeroLength <span style="color:#f92672">&lt;:</span> TLength <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">struct</span> TNext{T,L<span style="color:#f92672">&lt;:</span>TLength} <span style="color:#f92672">&lt;:</span> TLength <span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">abstract type</span> TStaticList{L<span style="color:#f92672">&lt;:</span>TLength} <span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> TNil <span style="color:#f92672">&lt;:</span> TStaticList{TZeroLength} <span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">struct</span> TCons{T, L<span style="color:#f92672">&lt;:</span>TLength} <span style="color:#f92672">&lt;:</span> TStaticList{TNext{T,L}}
    h<span style="color:#f92672">::</span>T
    t<span style="color:#f92672">::</span>TStaticList{L}
    <span style="color:#66d9ef">function</span> TCons(v<span style="color:#f92672">::</span>T, t<span style="color:#f92672">::</span>TStaticList{L}) where {T,L<span style="color:#f92672">&lt;:</span>TLength}
        new{T,L}(v,t)
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>With such construct, all nodes can be of a different type <code>T</code>, without
removing the type information from the compiler.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-julia" data-lang="julia">julia<span style="color:#f92672">&gt;</span> TCons(<span style="color:#ae81ff">3</span>,TNil())
TCons{<span style="color:#66d9ef">Int64</span>,TZeroLength}(<span style="color:#ae81ff">3</span>, TNil())

julia<span style="color:#f92672">&gt;</span> TCons(<span style="color:#e6db74">&#34;ha&#34;</span>, TCons(<span style="color:#ae81ff">3</span>,TNil()))
TCons{String,TNext{<span style="color:#66d9ef">Int64</span>,TZeroLength}}(<span style="color:#e6db74">&#34;ha&#34;</span>, TCons{<span style="color:#66d9ef">Int64</span>,TZeroLength}(<span style="color:#ae81ff">3</span>, TNil()))</code></pre></div>
<p>One interesting thing to note here is that the type takes the same
structure as the list itself:</p>
<p><strong>Type</strong>: either a <code>T</code> and a <code>TLength</code> containing the rest of the type, or <code>TNil</code><br>
<strong>Data</strong>: either a value of a given type and the rest of the list, or empty list</p>
<h1 id="conclusion">Conclusion</h1>
<p>The Julia type system and compiler allow for sophisticated specifications
when designing data structures, which gives it a feel of compiled languages.
This however should not be abused, in our little toy example, the type parameter
grows in complexity as the list does, which means the compiler has to carry out
some computation.</p>
<p>If you want some further compile-time tricks, <a href="https://www.youtube.com/watch?v=SeqAQHKLNj4">Andy Ferris&rsquo;s</a>
workshop at JuliaCon 2018 details how to perform compile-time computations
between bits and then bytes.</p>
<p>If you have any idea how to implement <code>StaticList</code> using integer parameters instead
of custom struct I would be glad to exchange. Porting this to
use <a href="https://github.com/vtjnash/ComputedFieldTypes.jl">ComputedFieldTypes.jl</a> might be a fun
experiment.</p>
<p>Feel free to reach out any way you prefer, <a href="https://twitter.com/matbesancon">Twitter</a>,
<a href="/#contact">email</a> to exchange or discuss this post.</p>
<hr>
<h1 id="sources">Sources</h1>
<p>Header image source: <a href="https://pxhere.com/en/photo/742575">https://pxhere.com/en/photo/742575</a></p>
<p>[1] A proposal on Julia &ldquo;Defer calculation of field types until type parameters are known&rdquo;, <a href="https://github.com/JuliaLang/julia/issues/18466">julia/issues/18466</a> <br>
[2] Discussion on compile-time computations on <a href="https://discourse.julialang.org/t/compile-time-arithmetic-for-parameterized-types/13991">Discourse</a></p>

    </div>

    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/julia/">julia</a>
  
</div>



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hu717a6920346f3d435e65e27c2a66c1ed_48773_250x250_fill_q90_lanczos_center.jpg" itemprop="image" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://matbesancon.github.io/">Mathieu Besançon</a></h5>
      <h6 class="card-subtitle">Postdoctoral researcher 22, mathematical optimization</h6>
      <p class="card-text" itemprop="description">Mathematical optimization, scientific programming and related.</p>
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="/#contact" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/matbesancon" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://scholar.google.com/citations?user=-xStCAIAAAAJ" target="_blank" rel="noopener">
              <i class="ai ai-google-scholar"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://github.com/matbesancon" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://orcid.org/0000-0002-6284-3033" target="_blank" rel="noopener">
              <i class="ai ai-orcid"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://www.youtube.com/channel/UCVSd42nW_MqkbSXijgOvKwg" target="_blank" rel="noopener">
              <i class="fab fa-youtube"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://linkedin.com/in/mbesancon" target="_blank" rel="noopener">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/post/2019-02-24-multiple-dispatch-optimizers/">Multiple dispatch - an example for mathematical optimizers</a></li>
          
          <li><a href="/post/2018-12-27-heat-exchanger/">Winter warm-up: toy models for heat exchangers</a></li>
          
          <li><a href="/post/2018-08-17-abstract_graph/">Building our own graph type in Julia</a></li>
          
          <li><a href="/post/2018-05-25-colgen2/">The cutting stock problem: part 2, solving with column generation</a></li>
          
          <li><a href="/post/2018-05-23-colgen/">Tackling the cutting stock problem: part 1, problem exploration</a></li>
          
        </ul>
      </div>
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.0.0/mermaid.min.js" integrity="sha256-0w92bcB21IY5+rGI84MGj52jNfHNbXVeQLrZ0CGdjNY=" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/julia.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/scala.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/rust.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/go.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/shell.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/dockerfile.min.js"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.16bbb3750feb7244c9bc409a5a4fe678.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    © 2021 Mathieu Besançon &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
